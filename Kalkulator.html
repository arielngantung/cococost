<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator HPP - Sesuai Metode Excel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Pustaka untuk membuat file Excel dengan Gaya (xlsx-js-style) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style/dist/xlsx.bundle.js"></script>
    <!-- Pustaka untuk membuat Grafik (Chart.js) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f9fafb;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .step-indicator {
            transition: all 0.3s ease;
        }
        .step-indicator.active {
            background-color: #16A34A; /* green-600 */
            color: white;
            border-color: #16A34A;
        }
        .step-indicator.completed {
            background-color: #10B981; /* emerald-500 */
            color: white;
            border-color: #10B981;
        }
        .form-section {
            display: none;
        }
        .form-section.active {
            display: block;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header -->
     <header class="bg-white/80 backdrop-blur-md fixed top-0 left-0 right-0 z-50 shadow-sm">
        <div class="w-full px-6 py-3 flex justify-between items-center">
           <a href="#">
                <img src="img/Logo1removbg.png" alt="CocoCost Logo" class="h-12 md:h-16">
            </a>
            <nav class="hidden md:flex items-center space-x-8">
                <a href="index.html" class="text-gray-600 hover:text-green-600">Home</a>
                <a href="index.html" class="text-gray-600 hover:text-green-600">About</a>
                <a href="Kalkulator.html" class="text-gray-600 hover:text-green-600">Contact</a>
                <a href="#" class="text-gray-600 hover:text-green-600">Panduan</a>
            </nav>
            <!-- MobileMenuBtn -->
            <button id="mobile-menu-button" class="md:hidden ml-4 text-gray-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden px-6 pb-4">
            <a href="index.html" class="block py-2 text-gray-600 hover:text-green-600">Home</a>
            <a href="index.html" class="block py-2 text-gray-600 hover:text-green-600">About</a>
            <a href="index.html#Kontak" class="block py-2 text-gray-600 hover:text-green-600">Contact</a>
            <a href="#" class="block py-2 text-gray-600 hover:text-green-600">Panduan</a>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8 max-w-6xl pt-24 relative z-10">
        <br> <br> <br>
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Kalkulator Harga Pokok Produksi</h1>
        </div>

        <!-- Step Indicator -->
        <div class="w-full max-w-4xl mx-auto mb-12">
            <div class="flex items-center justify-center">
                <div class="flex items-center flex-col md:flex-row">
                    <div id="step-indicator-1" class="step-indicator active flex items-center justify-center w-10 h-10 rounded-full border-2 border-gray-300 font-bold">1</div>
                    <p class="ml-0 md:ml-2 mt-1 md:mt-0 text-sm md:text-base">Produk</p>
                </div>
                <div class="flex-auto border-t-2 border-gray-300 mx-4"></div>
                <div class="flex items-center flex-col md:flex-row">
                    <div id="step-indicator-2" class="step-indicator flex items-center justify-center w-10 h-10 rounded-full border-2 border-gray-300 font-bold">2</div>
                    <p class="ml-0 md:ml-2 mt-1 md:mt-0 text-sm md:text-base">Biaya</p>
                </div>
                <div class="flex-auto border-t-2 border-gray-300 mx-4"></div>
                <div class="flex items-center flex-col md:flex-row">
                    <div id="step-indicator-3" class="step-indicator flex items-center justify-center w-10 h-10 rounded-full border-2 border-gray-300 font-bold">3</div>
                    <p class="ml-0 md:ml-2 mt-1 md:mt-0 text-sm md:text-base">Alokasi</p>
                </div>
                <div class="flex-auto border-t-2 border-gray-300 mx-4"></div>
                <div class="flex items-center flex-col md:flex-row">
                    <div id="step-indicator-4" class="step-indicator flex items-center justify-center w-10 h-10 rounded-full border-2 border-gray-300 font-bold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <p class="ml-0 md:ml-2 mt-1 md:mt-0 text-sm md:text-base">Dashboard</p>
                </div>
            </div>
        </div>

        <!-- Step 1: Produk & Volume Produksi -->
        <section id="step-1" class="form-section active">
            <div class="card">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Langkah 1: Tentukan Produk Utama</h2>
                <div id="product-list"></div>
                <button onclick="addProduct()" class="mt-4 w-full bg-green-100 text-green-700 font-semibold py-2 px-4 rounded-lg hover:bg-green-200 transition">
                    + Tambah Produk Utama
                </button>
                
                <div class="mt-8 pt-6 border-t">
                    <h3 class="text-xl font-semibold mb-2 text-gray-700">Produk Tambahan (Pengurang Biaya)</h3>
                    <p class="text-sm text-gray-600 mb-4">Masukkan produk sampingan atau tambahan yang nilainya akan mengurangi total biaya produksi.</p>
                    <div id="additional-product-list"></div>
                    <button onclick="addAdditionalProduct()" class="mt-4 w-full bg-blue-100 text-blue-700 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200 transition">
                        + Tambah Produk Tambahan
                    </button>
                </div>
            </div>
        </section>

        <!-- Step 2: Biaya Langsung & Overhead -->
        <section id="step-2" class="form-section">
            <div class="card">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Langkah 2: Input Total Biaya Produksi</h2>
                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-2 text-gray-700">Biaya Bahan Baku (BBB)</h3>
                    <div id="bbb-list" class="space-y-4"></div>
                    <button onclick="addBBB()" class="mt-4 w-full bg-green-100 text-green-700 font-semibold py-2 px-4 rounded-lg hover:bg-green-200 transition">
                        + Tambah Bahan Baku
                    </button>
                </div>
                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-2 text-gray-700">Biaya Tenaga Kerja Langsung (BTKL)</h3>
                    <div id="btkl-list" class="space-y-4"></div>
                    <button onclick="addBTKL()" class="mt-4 w-full bg-green-100 text-green-700 font-semibold py-2 px-4 rounded-lg hover:bg-green-200 transition">
                        + Tambah Pekerjaan BTKL
                    </button>
                </div>
                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-2 text-gray-700">Biaya Overhead Pabrik (BOP)</h3>
                    <div id="bop-list" class="space-y-4"></div>
                    <button onclick="addBOP()" class="mt-4 w-full bg-green-100 text-green-700 font-semibold py-2 px-4 rounded-lg hover:bg-green-200 transition">
                        + Tambah Aktivitas BOP
                    </button>
                </div>
            </div>
        </section>

        <!-- Step 3: Alokasi Biaya -->
        <section id="step-3" class="form-section">
            <div class="card">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Langkah 3: Alokasikan Biaya ke Setiap Produk</h2>
                <p class="text-sm text-gray-600 mb-4">Isi berapa banyak sumber daya yang dikonsumsi oleh <strong>satu unit</strong> dari setiap produk.</p>
                <div id="allocation-table-container" class="overflow-x-auto"></div>
            </div>
        </section>

        <!-- Step 4: Dashboard -->
        <section id="step-4" class="form-section">
             <div class="card">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-2xl font-semibold">Hasil Akhir: Dashboard HPP</h2>
                    <button onclick="downloadExcel()" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-4 rounded-lg transition text-sm flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 9.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 7.414V13a1 1 0 11-2 0V7.414L6.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                        </svg>
                        Unduh Excel
                    </button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="text-sm font-semibold text-green-800">TOTAL BIAYA PRODUKSI</h4>
                        <p id="dashboard-total-cost" class="text-2xl font-bold text-green-900">Rp 0</p>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="text-sm font-semibold text-blue-800">JUMLAH UNIT PRODUKSI</h4>
                        <p id="dashboard-total-units" class="text-2xl font-bold text-blue-900">0</p>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h4 class="text-sm font-semibold text-yellow-800">HPP RATA-RATA</h4>
                        <p id="dashboard-avg-hpp" class="text-2xl font-bold text-yellow-900">Rp 0</p>
                    </div>
                </div>

                <div id="cost-structure-section" class="mt-8">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Struktur Biaya Produksi</h3>
                    <div id="cost-structure-chart" class="space-y-4 p-4 bg-gray-50 rounded-lg"></div>
                </div>

                <div id="hpp-comparison-section" class="mt-8">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Perbandingan HPP per Unit Produk</h3>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <canvas id="hpp-comparison-chart"></canvas>
                    </div>
                </div>

                <div class="mt-8">
                    <h3 class="text-xl font-semibold mb-2 text-gray-700">Laporan Harga Pokok Produksi</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produk</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">BBB/Unit</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">BTKL/Unit</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">BOP/Unit</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">HPP/Unit</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total Biaya</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
             </div>
        </section>

        <!-- Navigation Buttons -->
        <div class="mt-8 flex justify-between">
            <button id="prev-btn" onclick="navigate(-1)" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg transition" style="display: none;">Kembali</button>
            <button id="next-btn" onclick="navigate(1)" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition ml-auto">Lanjut</button>
        </div>
         <div class="mt-4 text-center">
            <button onclick="resetCalculator()" class="text-sm text-gray-500 hover:text-red-600">Reset Kalkulator</button>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenuButton) {
                mobileMenuButton.addEventListener('click', () => {
                    mobileMenu.classList.toggle('hidden');
                });
            }
        });

        let currentStep = 1;
        let calculatorData = {};
        let hppChart = null;

        function getInitialData() {
            return {
                products: [],
                additionalProducts: [],
                bbbs: [],
                btkls: [],
                bop: [],
                allocations: {}
            };
        }

        function renderProducts() {
            const list = document.getElementById('product-list');
            if (calculatorData.products.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 py-4">Belum ada produk utama. Silakan tambahkan.</p>';
                return;
            }
            list.innerHTML = calculatorData.products.map(p => `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-2 items-center p-2 border-b" id="product-${p.id}">
                    <input type="text" value="${p.name}" onchange="updateProduct(${p.id}, 'name', this.value)" placeholder="Nama Produk" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                    <input type="number" value="${p.volume || ''}" onchange="updateProduct(${p.id}, 'volume', this.value)" placeholder="Volume Produksi" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                    <button onclick="removeProduct(${p.id})" class="bg-red-100 text-red-700 px-3 py-2 rounded-md hover:bg-red-200 transition text-sm">Hapus</button>
                </div>
            `).join('');
        }
        
        function renderAdditionalProducts() {
            const list = document.getElementById('additional-product-list');
            if (calculatorData.additionalProducts.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500 py-4">Belum ada produk tambahan.</p>';
                return;
            }
            list.innerHTML = calculatorData.additionalProducts.map(p => `
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-2 items-center p-2 border-b" id="add-product-${p.id}">
                    <input type="text" value="${p.name}" onchange="updateAdditionalProduct(${p.id}, 'name', this.value)" placeholder="Nama Produk Tambahan" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <input type="number" value="${p.quantity || ''}" onchange="updateAdditionalProduct(${p.id}, 'quantity', this.value)" placeholder="Jumlah" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <input type="number" value="${p.price || ''}" onchange="updateAdditionalProduct(${p.id}, 'price', this.value)" placeholder="Harga per Unit (Rp)" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                    <button onclick="removeAdditionalProduct(${p.id})" class="bg-red-100 text-red-700 px-3 py-2 rounded-md hover:bg-red-200 transition text-sm">Hapus</button>
                </div>
            `).join('');
        }

        function renderCosts() {
            const bbbList = document.getElementById('bbb-list');
            if (calculatorData.bbbs.length === 0) {
                bbbList.innerHTML = '<p class="text-center text-gray-500 py-4">Belum ada bahan baku. Silakan tambahkan.</p>';
            } else {
                bbbList.innerHTML = calculatorData.bbbs.map(b => `
                    <div class="p-4 border rounded-lg" id="bbb-${b.id}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" value="${b.name}" onchange="updateBBB(${b.id}, 'name', this.value)" placeholder="Nama Bahan Baku" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                            <input type="number" value="${b.cost || ''}" onchange="updateBBB(${b.id}, 'cost', this.value)" placeholder="Total Biaya (Rp)" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                            <input type="text" value="${b.driverName}" onchange="updateBBB(${b.id}, 'driverName', this.value)" placeholder="Unit Driver (cth: kg, liter)" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                            <input type="number" value="${b.units || ''}" onchange="updateBBB(${b.id}, 'units', this.value)" placeholder="Total Unit Driver" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                        </div>
                         <button onclick="removeBBB(${b.id})" class="mt-2 text-xs text-red-500 hover:text-red-700">Hapus Bahan Baku</button>
                    </div>
                `).join('');
            }

            const btklList = document.getElementById('btkl-list');
            if (calculatorData.btkls.length === 0) {
                btklList.innerHTML = '<p class="text-center text-gray-500 py-4">Belum ada pekerjaan. Silakan tambahkan.</p>';
            } else {
                btklList.innerHTML = calculatorData.btkls.map(b => `
                    <div class="p-4 border rounded-lg" id="btkl-${b.id}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" value="${b.name}" onchange="updateBTKL(${b.id}, 'name', this.value)" placeholder="Jenis Pekerjaan" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                            <input type="number" value="${b.cost || ''}" onchange="updateBTKL(${b.id}, 'cost', this.value)" placeholder="Total Biaya (Rp)" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                            <input type="text" value="${b.driverName}" onchange="updateBTKL(${b.id}, 'driverName', this.value)" placeholder="Unit Driver (cth: Jam Kerja)" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                            <input type="number" value="${b.hours || ''}" onchange="updateBTKL(${b.id}, 'hours', this.value)" placeholder="Total Unit Driver" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                        </div>
                         <button onclick="removeBTKL(${b.id})" class="mt-2 text-xs text-red-500 hover:text-red-700">Hapus Pekerjaan</button>
                    </div>
                `).join('');
            }

            const bopList = document.getElementById('bop-list');
             if (calculatorData.bop.length === 0) {
                bopList.innerHTML = '<p class="text-center text-gray-500 py-4">Belum ada aktivitas BOP. Silakan tambahkan.</p>';
            } else {
                bopList.innerHTML = calculatorData.bop.map(b => `
                    <div class="p-4 border rounded-lg" id="bop-${b.id}">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" value="${b.name}" onchange="updateBOP(${b.id}, 'name', this.value)" placeholder="Nama Aktivitas BOP" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                            <input type="number" value="${b.cost || ''}" onchange="updateBOP(${b.id}, 'cost', this.value)" placeholder="Total Biaya (Rp)" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                            <input type="text" value="${b.driverName}" onchange="updateBOP(${b.id}, 'driverName', this.value)" placeholder="Nama Cost Driver" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                            <input type="number" value="${b.driverUnits || ''}" onchange="updateBOP(${b.id}, 'driverUnits', this.value)" placeholder="Jumlah Cost Driver" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                        </div>
                         <button onclick="removeBOP(${b.id})" class="mt-2 text-xs text-red-500 hover:text-red-700">Hapus Aktivitas</button>
                    </div>
                `).join('');
            }
        }
        
        function renderAllocationTable() {
            const container = document.getElementById('allocation-table-container');
            if (calculatorData.products.length === 0) {
                 container.innerHTML = '<p class="text-center text-gray-500 py-4">Silakan tambahkan produk dan biaya terlebih dahulu.</p>';
                return;
            }
            
            let header = `<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Produk</th>`;
            calculatorData.bbbs.forEach(b => {
                header += `<th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" title="${b.name}">${b.driverName || 'Driver BBB'}</th>`;
            });
            calculatorData.btkls.forEach(b => {
                header += `<th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" title="${b.name}">${b.driverName || 'Driver BTKL'}</th>`;
            });
            calculatorData.bop.forEach(b => {
                header += `<th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider" title="${b.name}">${b.driverName || 'Driver BOP'}</th>`;
            });

            let body = '';
            calculatorData.products.forEach(p => {
                let row = `<td class="px-4 py-4 whitespace-nowrap font-medium text-gray-900">${p.name || `Produk #${p.id}`}</td>`;
                const alloc = calculatorData.allocations[p.id] || { bbbs: {}, btkls: {}, bop: {} };
                
                calculatorData.bbbs.forEach(b => {
                    const bbbAlloc = (alloc.bbbs && alloc.bbbs[b.id]) ? alloc.bbbs[b.id] : 0;
                    row += `<td><input type="number" step="any" value="${bbbAlloc || ''}" onchange="updateAllocation(${p.id}, 'bbb', ${b.id}, this.value)" placeholder="0" class="w-24 mx-auto block rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-center"></td>`;
                });
                calculatorData.btkls.forEach(b => {
                    const btklAlloc = (alloc.btkls && alloc.btkls[b.id]) ? alloc.btkls[b.id] : 0;
                    row += `<td><input type="number" step="any" value="${btklAlloc || ''}" onchange="updateAllocation(${p.id}, 'btkl', ${b.id}, this.value)" placeholder="0" class="w-24 mx-auto block rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-center"></td>`;
                });
                calculatorData.bop.forEach(b => {
                    const bopAlloc = (alloc.bop && alloc.bop[b.id]) ? alloc.bop[b.id] : 0;
                    row += `<td><input type="number" step="any" value="${bopAlloc || ''}" onchange="updateAllocation(${p.id}, 'bop', ${b.id}, this.value)" placeholder="0" class="w-24 mx-auto block rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 text-center"></td>`;
                });

                body += `<tr class="border-b">${row}</tr>`;
            });

            container.innerHTML = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>${header}</tr></thead><tbody class="bg-white divide-y divide-gray-200">${body}</tbody></table>`;
        }

        function addProduct() {
            const newId = (calculatorData.products.length > 0 ? Math.max(...calculatorData.products.map(p => p.id)) : 0) + 1;
            calculatorData.products.push({ id: newId, name: '', volume: 0 });
            calculatorData.allocations[newId] = { bbbs: {}, btkls:{}, bop: {} };
            renderProducts();
        }

        function removeProduct(id) {
            calculatorData.products = calculatorData.products.filter(p => p.id !== id);
            delete calculatorData.allocations[id];
            renderProducts();
        }

        function updateProduct(id, field, value) {
            const product = calculatorData.products.find(p => p.id === id);
            if (product) {
                product[field] = (field === 'name') ? value : parseFloat(value) || 0;
            }
        }

        function addAdditionalProduct() {
            const newId = (calculatorData.additionalProducts.length > 0 ? Math.max(...calculatorData.additionalProducts.map(p => p.id)) : 0) + 1;
            calculatorData.additionalProducts.push({ id: newId, name: '', quantity: 0, price: 0 });
            renderAdditionalProducts();
        }

        function removeAdditionalProduct(id) {
            calculatorData.additionalProducts = calculatorData.additionalProducts.filter(p => p.id !== id);
            renderAdditionalProducts();
        }

        function updateAdditionalProduct(id, field, value) {
            const product = calculatorData.additionalProducts.find(p => p.id === id);
            if (product) {
                product[field] = (field === 'name') ? value : parseFloat(value) || 0;
            }
        }

        function addBBB() {
            const newId = (calculatorData.bbbs.length > 0 ? Math.max(...calculatorData.bbbs.map(b => b.id)) : 0) + 1;
            calculatorData.bbbs.push({ id: newId, name: '', cost: 0, driverName: '', units: 0 });
            renderCosts();
        }
        function removeBBB(id) {
            calculatorData.bbbs = calculatorData.bbbs.filter(b => b.id !== id);
            Object.values(calculatorData.allocations).forEach(alloc => { delete alloc.bbbs[id]; });
            renderCosts();
        }
        function updateBBB(id, field, value) {
            const bbb = calculatorData.bbbs.find(b => b.id === id);
            if (bbb) {
                bbb[field] = ['name', 'driverName'].includes(field) ? value : parseFloat(value) || 0;
            }
        }

        function addBTKL() {
            const newId = (calculatorData.btkls.length > 0 ? Math.max(...calculatorData.btkls.map(b => b.id)) : 0) + 1;
            calculatorData.btkls.push({ id: newId, name: '', cost: 0, driverName: '', hours: 0 });
            renderCosts();
        }
        function removeBTKL(id) {
            calculatorData.btkls = calculatorData.btkls.filter(b => b.id !== id);
            Object.values(calculatorData.allocations).forEach(alloc => { delete alloc.btkls[id]; });
            renderCosts();
        }
        function updateBTKL(id, field, value) {
            const btkl = calculatorData.btkls.find(b => b.id === id);
            if (btkl) {
                btkl[field] = ['name', 'driverName'].includes(field) ? value : parseFloat(value) || 0;
            }
        }

        function addBOP() {
            const newId = (calculatorData.bop.length > 0 ? Math.max(...calculatorData.bop.map(b => b.id)) : 0) + 1;
            calculatorData.bop.push({ id: newId, name: '', cost: 0, driverName: '', driverUnits: 0 });
            renderCosts();
        }

        function removeBOP(id) {
            calculatorData.bop = calculatorData.bop.filter(b => b.id !== id);
            Object.values(calculatorData.allocations).forEach(alloc => { delete alloc.bop[id]; });
            renderCosts();
        }

        function updateBOP(id, field, value) {
            const bop = calculatorData.bop.find(b => b.id === id);
            if (bop) {
                bop[field] = ['name', 'driverName'].includes(field) ? value : parseFloat(value) || 0;
            }
        }

        function updateAllocation(productId, type, typeId, value) {
            const val = parseFloat(value) || 0;
            const alloc = calculatorData.allocations[productId];
            if (!alloc) return;

            if (type === 'bbb') {
                if (!alloc.bbbs) alloc.bbbs = {};
                alloc.bbbs[typeId] = val;
            } else if (type === 'btkl') {
                if (!alloc.btkls) alloc.btkls = {};
                alloc.btkls[typeId] = val;
            } else { // BOP
                if (!alloc.bop) alloc.bop = {};
                alloc.bop[typeId] = val;
            }
        }
        
        function calculateHPP() {
            const results = [];
            const totalProductionUnits = calculatorData.products.reduce((sum, p) => sum + (p.volume || 0), 0);

            const totalBBBCost = calculatorData.bbbs.reduce((sum, b) => sum + (b.cost || 0), 0);
            const totalBTKLCost = calculatorData.btkls.reduce((sum, b) => sum + (b.cost || 0), 0);

            const bbbAverageRate = (totalProductionUnits > 0) ? totalBBBCost / totalProductionUnits : 0;
            const btklAverageRate = (totalProductionUnits > 0) ? totalBTKLCost / totalProductionUnits : 0;
            
            const bopRates = {};
            calculatorData.bop.forEach(b => {
                bopRates[b.id] = (b.driverUnits > 0) ? b.cost / b.driverUnits : 0;
            });

            let grossTotalProductionCost = 0;
            let totalBBB = 0;
            let totalBTKL = 0;
            let totalBOP = 0;

            for (const product of calculatorData.products) {
                const alloc = calculatorData.allocations[product.id];
                if (!alloc) continue;

                const totalBBBAllocationFactor = Object.values(alloc.bbbs || {}).reduce((sum, val) => sum + val, 0);
                const totalBTKLAllocationFactor = Object.values(alloc.btkls || {}).reduce((sum, val) => sum + val, 0);

                const bbbPerUnit = totalBBBAllocationFactor * bbbAverageRate;
                const btklPerUnit = totalBTKLAllocationFactor * btklAverageRate;
                
                let bopPerUnit = 0;
                calculatorData.bop.forEach(b => {
                    const consumption = (alloc.bop && alloc.bop[b.id]) ? alloc.bop[b.id] : 0;
                    bopPerUnit += consumption * bopRates[b.id];
                });

                const hppPerUnit = bbbPerUnit + btklPerUnit + bopPerUnit;
                const totalCostForProduct = hppPerUnit * (product.volume || 0);

                results.push({
                    name: product.name,
                    volume: product.volume || 0,
                    bbbPerUnit,
                    btklPerUnit,
                    bopPerUnit,
                    hppPerUnit,
                    totalCost: totalCostForProduct
                });
                
                totalBBB += bbbPerUnit * (product.volume || 0);
                totalBTKL += btklPerUnit * (product.volume || 0);
                totalBOP += bopPerUnit * (product.volume || 0);
            }
            
            grossTotalProductionCost = totalBBB + totalBTKL + totalBOP;
            
            const additionalProductsValue = calculatorData.additionalProducts.reduce((sum, p) => {
                return sum + ((p.quantity || 0) * (p.price || 0));
            }, 0);
            const netTotalProductionCost = grossTotalProductionCost - additionalProductsValue;

            const avgHpp = totalProductionUnits > 0 ? netTotalProductionCost / totalProductionUnits : 0;
            
            const bbbPercentage = (grossTotalProductionCost > 0) ? (totalBBB / grossTotalProductionCost) * 100 : 0;
            const btklPercentage = (grossTotalProductionCost > 0) ? (totalBTKL / grossTotalProductionCost) * 100 : 0;
            const bopPercentage = (grossTotalProductionCost > 0) ? (totalBOP / grossTotalProductionCost) * 100 : 0;

            return { 
                results, 
                totalProductionCost: netTotalProductionCost,
                grossTotalProductionCost,
                additionalProductsValue,
                totalProductionUnits, 
                avgHpp,
                costStructure: { 
                    totalBBB, 
                    totalBTKL, 
                    totalBOP, 
                    bbbPercentage, 
                    btklPercentage, 
                    bopPercentage 
                }
            };
        }
        
        function renderDashboard() {
            const { results, totalProductionCost, totalProductionUnits, avgHpp, costStructure } = calculateHPP();
            const formatCurrency = (value) => `Rp ${value.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            document.getElementById('dashboard-total-cost').textContent = formatCurrency(totalProductionCost);
            document.getElementById('dashboard-total-units').textContent = totalProductionUnits.toLocaleString('id-ID');
            document.getElementById('dashboard-avg-hpp').textContent = formatCurrency(avgHpp);

            const tableBody = document.getElementById('dashboard-table-body');
            tableBody.innerHTML = results.map(r => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">${r.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">${formatCurrency(r.bbbPerUnit)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">${formatCurrency(r.btklPerUnit)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">${formatCurrency(r.bopPerUnit)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right font-bold text-green-600">${formatCurrency(r.hppPerUnit)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">${formatCurrency(r.totalCost)}</td>
                </tr>
            `).join('');

            const chartContainer = document.getElementById('cost-structure-chart');
            if (costStructure.totalBBB + costStructure.totalBTKL + costStructure.totalBOP > 0) {
                chartContainer.innerHTML = `
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-base font-medium text-blue-700">Biaya Bahan Baku (BBB)</span>
                        <span class="text-sm font-medium text-blue-700">${costStructure.bbbPercentage.toFixed(2)}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="bg-blue-600 h-4 rounded-full" style="width: ${costStructure.bbbPercentage}%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-base font-medium text-orange-700">Biaya Tenaga Kerja (BTKL)</span>
                        <span class="text-sm font-medium text-orange-700">${costStructure.btklPercentage.toFixed(2)}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="bg-orange-500 h-4 rounded-full" style="width: ${costStructure.btklPercentage}%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-base font-medium text-red-700">Biaya Overhead (BOP)</span>
                        <span class="text-sm font-medium text-red-700">${costStructure.bopPercentage.toFixed(2)}%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4">
                        <div class="bg-red-600 h-4 rounded-full" style="width: ${costStructure.bopPercentage}%"></div>
                    </div>
                </div>
                `;
            } else {
                chartContainer.innerHTML = '<p class="text-center text-gray-500">Data biaya belum cukup untuk menampilkan struktur biaya.</p>';
            }

            const chartCanvas = document.getElementById('hpp-comparison-chart').getContext('2d');
            const productLabels = results.map(r => r.name);
            const hppData = results.map(r => r.hppPerUnit);

            if (hppChart) {
                hppChart.destroy(); 
            }

            hppChart = new Chart(chartCanvas, {
                type: 'bar',
                data: {
                    labels: productLabels,
                    datasets: [{
                        label: 'HPP per Unit (Rp)',
                        data: hppData,
                        backgroundColor: [
                            'rgba(22, 163, 74, 0.6)',
                            'rgba(37, 99, 235, 0.6)',
                            'rgba(217, 119, 6, 0.6)',
                            'rgba(220, 38, 38, 0.6)',
                            'rgba(107, 114, 128, 0.6)'
                        ],
                        borderColor: [
                            'rgba(22, 163, 74, 1)',
                            'rgba(37, 99, 235, 1)',
                            'rgba(217, 119, 6, 1)',
                            'rgba(220, 38, 38, 1)',
                            'rgba(107, 114, 128, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return ` HPP: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value, index, values) {
                                    return 'Rp ' + value.toLocaleString('id-ID');
                                }
                            }
                        }
                    }
                }
            });
        }

        function navigate(direction) {
            const newStep = currentStep + direction;
            if (newStep < 1 || newStep > 4) return;

            if (direction > 0) {
                 if (currentStep === 1) { renderCosts(); }
                 if (currentStep === 2) { renderAllocationTable(); }
                 if (currentStep === 3) { renderDashboard(); }
            }

            document.getElementById(`step-${currentStep}`).classList.remove('active');
            if (direction > 0) {
                document.getElementById(`step-indicator-${currentStep}`).classList.add('completed');
                document.getElementById(`step-indicator-${currentStep}`).classList.remove('active');
            } else {
                 document.getElementById(`step-indicator-${currentStep-1}`).classList.remove('completed');
            }

            currentStep = newStep;
            document.getElementById(`step-1`).classList.remove('active');
            document.getElementById(`step-2`).classList.remove('active');
            document.getElementById(`step-3`).classList.remove('active');
            document.getElementById(`step-4`).classList.remove('active');
            document.getElementById(`step-${currentStep}`).classList.add('active');
            document.getElementById(`step-indicator-${currentStep}`).classList.add('active');
            updateNavButtons();
        }

        function updateNavButtons() {
            document.getElementById('prev-btn').style.display = (currentStep > 1) ? 'block' : 'none';
            document.getElementById('next-btn').style.display = (currentStep < 4) ? 'block' : 'none';
        }

        function updateStepIndicators() {
            for (let i = 1; i <= 4; i++) {
                const indicator = document.getElementById(`step-indicator-${i}`);
                indicator.classList.remove('active', 'completed');
                if (i < currentStep) {
                    indicator.classList.add('completed');
                } else if (i === currentStep) {
                    indicator.classList.add('active');
                }
            }
        }
        
        function resetCalculator() {
            currentStep = 1;
            document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
            document.getElementById('step-1').classList.add('active');
            initialize(true);
            updateStepIndicators();
            updateNavButtons();
        }
        
        function initialize(isReset = false) {
            calculatorData = getInitialData();
            
            if (isReset || calculatorData.products.length === 0) {
                addProduct();
                addAdditionalProduct();
                addBBB();
                addBTKL();
                addBOP();
            } else {
                renderProducts();
                renderAdditionalProducts();
                renderCosts();
                renderAllocationTable();
                renderDashboard();
            }
        }

        // --- Function to create styled Excel report ---
        function createStyledReport(data) {
            // --- 1. Define Styles ---
            const titleStyle = {
                font: { name: 'Calibri', sz: 16, bold: true },
                alignment: { horizontal: 'center', vertical: 'center' }
            };
            const sectionHeaderStyle = {
                font: { name: 'Calibri', sz: 12, bold: true, color: { rgb: "000000" } },
                fill: { fgColor: { rgb: "D9D2E9" } }, // Light Purple Fill
                alignment: { horizontal: 'center', vertical: 'center' }
            };
            const plainColumnHeaderStyle = {
                font: { name: 'Calibri', sz: 11, bold: true },
                alignment: { horizontal: 'center', vertical: 'center' },
                border: {
                    top: { style: 'thin' }, bottom: { style: 'thin' },
                    left: { style: 'thin' }, right: { style: 'thin' }
                }
            };
            const dataCellStyle = {
                border: {
                    top: { style: 'thin' }, bottom: { style: 'thin' },
                    left: { style: 'thin' }, right: { style: 'thin' }
                },
                alignment: { vertical: 'center' }
            };
            const centeredDataCellStyle = {
                ...dataCellStyle,
                alignment: { horizontal: 'center', vertical: 'center' }
            };
            const labelCellStyle = { ...dataCellStyle, font: { bold: false } };
            // FIXED: New styles for bold cells
            const boldLabelCellStyle = { ...dataCellStyle, font: { bold: true } };
            const boldDataCellStyle = { ...dataCellStyle, font: { bold: true } };


            // --- 2. Define Number Formats ---
            const rpFormat = 'Rp#,##0.00';
            const unitFormat = '#,##0" unit"';
            const percentFormat = '0.00%';
            const rpParenthesesFormat = 'Rp#,##0.00;"Rp("#,##0.00")"';

            // --- 3. Prepare Data for Worksheet ---
            const { results, totalProductionCost, grossTotalProductionCost, additionalProductsValue, totalProductionUnits, avgHpp, costStructure } = data;

            const ws_data = [
                [], // Row 1 (empty)
                ['', 'HASIL AKHIR PERHITUNGAN HARGA POKOK PRODUKSI'], 
                [], 
                ['TOTAL BIAYA (Bruto)', grossTotalProductionCost], 
                ['PENGURANG BIAYA (Produk Tambahan)', -additionalProductsValue], 
                ['TOTAL BIAYA PRODUKSI (Neto)', totalProductionCost], 
                ['JUMLAH UNIT PRODUKSI', totalProductionUnits], 
                ['HPP RATA-RATA (Neto)', avgHpp], 
                [], [], 
                ['STRUKTUR BIAYA PRODUKSI'], 
                ['Komponen Biaya', 'Total Biaya', 'Persentase'], 
                ['Biaya Bahan Baku (BBB)', costStructure.totalBBB, costStructure.bbbPercentage / 100], 
                ['Biaya Tenaga Kerja (BTKL)', costStructure.totalBTKL, costStructure.btklPercentage / 100], 
                ['Biaya Overhead (BOP)', costStructure.totalBOP, costStructure.bopPercentage / 100], 
                [], [], 
                ['LAPORAN HARGA POKOK PRODUKSI'], 
                ['Produk', 'Volume', 'BBB/Unit', 'BTKL/Unit', 'BOP/Unit', 'HPP/Unit', 'Total Biaya']
            ];
            
            results.forEach(r => {
                ws_data.push([r.name, r.volume, r.bbbPerUnit, r.btklPerUnit, r.bopPerUnit, r.hppPerUnit, r.totalCost]);
            });

            // --- 4. Create Worksheet and Apply Styles ---
            const ws = XLSX.utils.aoa_to_sheet(ws_data);

            ws['!cols'] = [ { wch: 35 }, { wch: 18 }, { wch: 18 }, { wch: 18 }, { wch: 18 }, { wch: 18 }, { wch: 18 } ];
            ws['!merges'] = [
                { s: { r: 1, c: 1 }, e: { r: 1, c: 6 } }, 
                { s: { r: 10, c: 0 }, e: { r: 10, c: 2 } }, 
                { s: { r: 17, c: 0 }, e: { r: 17, c: 6 } }  
            ];

            // Apply styles and formats
            ws['B2'].s = titleStyle;
            ws['A11'].s = sectionHeaderStyle;
            ws['A18'].s = sectionHeaderStyle;

            ['A12', 'B12', 'C12'].forEach(key => { if(ws[key]) ws[key].s = plainColumnHeaderStyle; });
            ['A19', 'B19', 'C19', 'D19', 'E19', 'F19', 'G19'].forEach(key => { if(ws[key]) ws[key].s = plainColumnHeaderStyle; });

            // Loop through data rows to apply borders and formats
            for (let R = 3; R <= 7; ++R) { // Summary Section (NO COLOR)
                if(ws[`A${R+1}`]) ws[`A${R+1}`].s = labelCellStyle;
                if(ws[`B${R+1}`]) ws[`B${R+1}`].s = dataCellStyle;
            }
            for (let R = 12; R <= 14; ++R) { // Cost Structure Section
                ['A', 'B', 'C'].forEach(C => {
                    const cell = ws[`${C}${R+1}`];
                    if(cell) cell.s = (C === 'A') ? labelCellStyle : dataCellStyle;
                });
            }
            // Apply centered style to report data
            for (let R = 19; R < ws_data.length; ++R) { // Report Section
                ['A', 'B', 'C', 'D', 'E', 'F', 'G'].forEach(C => {
                    const cell_address = `${C}${R + 1}`;
                    const cell = ws[cell_address];
                    if (cell) {
                        if (C === 'A') {
                            cell.s = labelCellStyle; // Column A remains left-aligned
                        } else {
                            cell.s = centeredDataCellStyle; // Columns B-G are centered
                        }
                    }
                });
            }

            // FIXED: Apply bold style to specific summary rows
            if(ws['A6']) ws['A6'].s = boldLabelCellStyle;
            if(ws['B6']) ws['B6'].s = boldDataCellStyle;
            if(ws['A8']) ws['A8'].s = boldLabelCellStyle;
            if(ws['B8']) ws['B8'].s = boldDataCellStyle;

            // Apply Number Formats
            if(ws['B4']) ws['B4'].z = rpFormat;
            if(ws['B5']) ws['B5'].z = rpParenthesesFormat;
            if(ws['B6']) ws['B6'].z = rpFormat;
            if(ws['B7']) ws['B7'].z = unitFormat;
            if(ws['B8']) ws['B8'].z = rpFormat;
            
            if(ws['B13']) ws['B13'].z = rpFormat;
            if(ws['B14']) ws['B14'].z = rpFormat;
            if(ws['B15']) ws['B15'].z = rpFormat;
            if(ws['C13']) ws['C13'].z = percentFormat;
            if(ws['C14']) ws['C14'].z = percentFormat;
            if(ws['C15']) ws['C15'].z = percentFormat;

            results.forEach((r, index) => {
                const row = 20 + index;
                if(ws[`B${row}`]) ws[`B${row}`].z = unitFormat;
                if(ws[`C${row}`]) ws[`C${row}`].z = rpFormat;
                if(ws[`D${row}`]) ws[`D${row}`].z = rpFormat;
                if(ws[`E${row}`]) ws[`E${row}`].z = rpFormat;
                if(ws[`F${row}`]) ws[`F${row}`].z = rpFormat;
                if(ws[`G${row}`]) ws[`G${row}`].z = rpFormat;
            });

            return ws;
        }

        function downloadExcel() {
            const calculatedData = calculateHPP();
            if (calculatedData.results.length === 0) {
                alert("Tidak ada data untuk diunduh. Silakan lengkapi perhitungan terlebih dahulu.");
                return;
            }
            const newWorksheet = createStyledReport(calculatedData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, newWorksheet, "Laporan HPP");
            XLSX.writeFile(wb, "Laporan_HPP_Styled.xlsx");
        }

        window.onload = initialize;
    </script>
</body>
</html>
